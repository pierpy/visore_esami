<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Prof Manager</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#3f51b5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prof Manager">
    <link rel="apple-touch-icon" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.prod.css" rel="stylesheet" type="text/css">
    
    <style>
        :root {
            --q-primary: #3f51b5; 
            --q-secondary: #009688; 
            --bg-app: #f5f7fa; 
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-app); overscroll-behavior-y: none; }
        .q-layout { background-color: var(--bg-app) !important; }

        /* Header sfumato */
        .header-modern { background: linear-gradient(135deg, var(--q-primary) 0%, #5c6bc0 100%); }

        /* Carte generali */
        .modern-card {
            background: white; border-radius: 16px; border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05) !important;
        }

        /* DASHBOARD COMPATTA */
        .stat-card {
            background: white; border-radius: 12px; padding: 10px 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            text-align: center; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .stat-value { font-size: 1.4rem; font-weight: 700; line-height: 1.1; margin-top: 5px; color: #333; }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; font-weight: 600; color: #777; margin-top: 2px; }
        .stat-icon { font-size: 1.5rem; opacity: 0.8; }

        /* LISTA STUDENTI PULITA */
        .student-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 10px 0; 
            transition: background-color 0.2s;
        }
        .student-item:active { background-color: #f5f5f5; } 
        .student-item:last-child { border-bottom: none; }
        
        /* BADGE VOTO (MINIMAL) */
        .grade-badge {
            width: 28px; height: 28px; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; 
            font-size: 0.85rem; 
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .grade-pass { background: linear-gradient(45deg, #43A047, #66BB6A); }
        .grade-fail { background: linear-gradient(45deg, #e53935, #ef5350); }

        /* Bottoni Azione */
        .btn-gradient-scan { background: linear-gradient(45deg, #009688, #4DB6AC) !important; color: white; }
        .btn-gradient-manual { background: white !important; color: #455A64; border: 1px solid #cfd8dc; }
    </style>
</head>
<body>
    <div id="q-app">
        <q-layout view="lHh Lpr lFf">
            
            <q-header elevated class="header-modern text-white">
                <q-toolbar>
                    <q-btn flat round dense icon="arrow_back_ios_new" v-if="vistaCorrente === 'dettaglio'" @click="tornaHome"></q-btn>
                    <q-toolbar-title class="text-weight-bold" style="font-size: 1.1rem;">{{ titoloApp }}</q-toolbar-title>
                    <q-btn unelevated round color="white" text-color="primary" icon="add" v-if="vistaCorrente === 'home'" @click="dialogNuovoCorso = true" size="sm" class="shadow-2"></q-btn>
                </q-toolbar>
            </q-header>

            <q-page-container>
                <q-page class="q-pa-md">
                    
                    <div v-show="vistaCorrente === 'home'">
                        <div v-if="loading" class="text-center q-mt-xl"><q-spinner-dots size="4em" color="primary"></q-spinner-dots></div>
                        <div v-else>
                            <div class="text-h6 q-mb-md text-weight-bold text-dark">I tuoi Corsi</div>
                            
                            <q-banner v-if="listaCorsi.length === 0" class="bg-white text-dark q-mb-md modern-card">
                                <template v-slot:avatar><q-icon name="info" color="primary" /></template>
                                Nessun corso. Creane uno col tasto + in alto!
                            </q-banner>

                            <q-card v-for="corso in listaCorsi" :key="corso.id" class="modern-card q-mb-md cursor-pointer" v-ripple @click="apriCorso(corso)">
                                <q-card-section class="row items-center no-wrap">
                                    <q-avatar color="indigo-1" text-color="primary" icon="school" size="md"></q-avatar>
                                    <div class="q-ml-md col">
                                        <div class="text-subtitle1 text-weight-bold">{{ corso.nome }}</div>
                                        <div class="text-caption text-grey-7">{{ corso.data }}</div>
                                    </div>
                                    <q-btn flat round color="grey-5" icon="delete_outline" @click.stop="eliminaCorso(corso.id)"></q-btn>
                                </q-card-section>
                            </q-card>
                        </div>
                    </div>

                    <div v-show="vistaCorrente === 'dettaglio'">
                        
                        <div class="row q-col-gutter-sm q-mb-lg">
                            <div class="col-4">
                                <div class="stat-card">
                                    <q-icon name="bar_chart" class="stat-icon text-indigo"></q-icon>
                                    <div class="stat-value">{{ statistiche.media }}</div>
                                    <div class="stat-label">Media</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <q-icon name="check_circle" class="stat-icon text-green"></q-icon>
                                    <div class="stat-value text-green">{{ statistiche.promossi }}</div>
                                    <div class="stat-label">Promossi</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card">
                                    <q-icon name="cancel" class="stat-icon text-red"></q-icon>
                                    <div class="stat-value text-red">{{ statistiche.bocciati }}</div>
                                    <div class="stat-label">Bocciati</div>
                                </div>
                            </div>
                        </div>

                        <div class="row q-mb-md items-center q-gutter-sm">
                            <div class="col">
                                <q-input outlined dense v-model="testoRicerca" placeholder="Cerca studente..." class="bg-white" style="border-radius: 10px;">
                                    <template v-slot:prepend><q-icon name="search" color="grey-5" /></template>
                                </q-input>
                            </div>
                            <div class="col-auto">
                                <q-btn unelevated round color="white" text-color="teal" icon="file_download" @click="scaricaExcel" class="shadow-1">
                                    <q-tooltip>Esporta Excel</q-tooltip>
                                </q-btn>
                            </div>
                        </div>

                        <div class="row q-col-gutter-md q-mb-lg">
                            <div class="col-7">
                                <q-btn class="full-width btn-gradient-scan shadow-3" icon="document_scanner" label="Scansiona" size="md" rounded no-caps @click="attivaCamera" padding="10px"></q-btn>
                            </div>
                            <div class="col-5">
                                <q-btn class="full-width btn-gradient-manual shadow-1" icon="edit_note" label="Manuale" size="md" rounded no-caps @click="apriInserimentoManuale" padding="10px"></q-btn>
                            </div>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" @change="processaImmagine">
                        </div>

                        <div class="text-subtitle2 text-grey-7 q-mb-sm q-ml-xs">Elenco Studenti ({{ studentiFiltrati.length }})</div>
                        
                        <q-list class="bg-white rounded-borders shadow-1 q-py-sm">
                            <div v-if="studentiFiltrati.length === 0" class="text-center q-pa-lg text-grey">
                                Nessuno studente trovato.<br>Usa i tasti sopra per aggiungere.
                            </div>

                            <q-item v-for="studente in studentiFiltrati" :key="studente.id" class="student-item" clickable v-ripple @click="modificaStudente(studente)">
                                
                                <q-item-section avatar style="min-width: 35px; padding-right: 0;">
                                    <div class="grade-badge" :class="studente.voto >= 18 ? 'grade-pass' : 'grade-fail'">
                                        {{ studente.voto }}
                                    </div>
                                </q-item-section>

                                <q-item-section>
                                    <q-item-label class="text-weight-bold text-dark" style="font-size: 0.95rem;">
                                        {{ studente.cognome }} {{ studente.nome }}
                                    </q-item-label>
                                    <q-item-label caption class="text-grey-6" style="font-size: 0.75rem;">
                                        Matr: {{ studente.matricola }}
                                    </q-item-label>
                                </q-item-section>

                                <q-item-section side>
                                    <div class="row no-wrap items-center">
                                        <q-btn v-if="studente.foto_url" flat round dense color="primary" icon="image" size="sm" @click.stop="mostraFotoProva(studente.foto_url)"></q-btn>
                                        
                                        <q-btn flat round dense color="grey-4" icon="delete_outline" size="sm" @click.stop="eliminaStudente(studente.id)"></q-btn>
                                    </div>
                                </q-item-section>
                            </q-item>
                        </q-list>

                        <div class="q-pb-xl"></div> </div>
                </q-page>
            </q-page-container>

            <q-dialog v-model="dialogStudente" persistent transition-show="scale" transition-hide="scale">
                <q-card style="width: 100vw; max-width: 400px; border-radius: 16px;">
                    <q-card-section class="bg-primary text-white row items-center">
                        <div class="text-h6 text-weight-bold col">{{ studenteForm.id ? 'Modifica' : 'Nuovo' }}</div>
                        <q-btn dense flat icon="close" color="white" v-close-popup></q-btn>
                    </q-card-section>

                    <q-card-section class="q-pt-lg">
                        <div v-if="anteprimaImg || studenteForm.foto_url" class="q-mb-md text-center">
                            <img :src="anteprimaImg || studenteForm.foto_url" 
                                 style="width:100%; height: 180px; object-fit: contain; background: #f0f0f0; border-radius: 8px; border: 1px solid #ddd;"
                                 @click="mostraFotoProva(anteprimaImg || studenteForm.foto_url)"
                            >
                            <div class="text-caption text-grey q-mt-xs">Tocca per ingrandire</div>
                        </div>
                        
                        <div class="q-gutter-md">
                            <q-input outlined v-model="studenteForm.matricola" label="Matricola" type="number" dense>
                                <template v-slot:prepend><q-icon name="pin" color="primary" /></template>
                            </q-input>
                            <div class="row q-col-gutter-sm">
                                <div class="col-6"><q-input outlined v-model="studenteForm.nome" label="Nome" dense></q-input></div>
                                <div class="col-6"><q-input outlined v-model="studenteForm.cognome" label="Cognome" dense></q-input></div>
                            </div>
                            <q-input outlined v-model="studenteForm.voto" label="Voto" type="number" class="text-h6 text-weight-bold" dense>
                                <template v-slot:prepend><q-icon name="grade" color="secondary" /></template>
                            </q-input>
                        </div>
                    </q-card-section>

                    <q-card-actions align="right" class="q-pa-md bg-grey-1">
                        <q-btn flat label="Annulla" color="grey" v-close-popup no-caps></q-btn>
                        <q-btn unelevated rounded :label="studenteForm.id ? 'Aggiorna' : 'Salva'" color="primary" class="q-px-lg" @click="salvaStudenteDB" no-caps></q-btn>
                    </q-card-actions>
                </q-card>
            </q-dialog>

            <q-dialog v-model="dialogNuovoCorso">
                <q-card style="min-width: 300px; border-radius: 16px;">
                    <q-card-section>
                        <div class="text-h6 text-primary">Nuovo Corso</div>
                    </q-card-section>
                    <q-card-section>
                        <q-input outlined v-model="nuovoCorso.nome" label="Nome Materia" autofocus dense></q-input>
                    </q-card-section>
                    <q-card-actions align="right">
                        <q-btn flat label="Annulla" v-close-popup no-caps></q-btn>
                        <q-btn unelevated rounded label="Crea" color="primary" @click="salvaCorso" v-close-popup no-caps></q-btn>
                    </q-card-actions>
                </q-card>
            </q-dialog>

            <q-dialog v-model="dialogFotoProva">
                <q-card style="width: 100vw; max-width: 600px;">
                    <q-card-section class="row items-center q-pb-none bg-grey-2">
                        <div class="text-h6">Prova d'Esame</div>
                        <q-space></q-space>
                        <q-btn icon="close" flat round dense v-close-popup></q-btn>
                    </q-card-section>
                    <q-card-section class="q-pa-none bg-black text-center">
                        <img :src="fotoProvaUrl" style="max-width: 100%; max-height: 80vh;">
                    </q-card-section>
                </q-card>
            </q-dialog>

        </q-layout>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.umd.prod.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script src="app.js"></script>
</body>
</html>