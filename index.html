<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Prof Manager Pro</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.prod.css" rel="stylesheet" type="text/css">
    <style> .my-card { margin-bottom: 15px; border-left: 5px solid #1976D2; } </style>
</head>
<body>
    <div id="q-app">
        <q-layout view="lHh Lpr lFf" class="bg-grey-1">
            
            <q-header elevated class="bg-primary text-white">
                <q-toolbar>
                    <q-btn flat round dense icon="arrow_back" v-if="vistaCorrente === 'dettaglio'" @click="tornaHome"></q-btn>
                    <q-toolbar-title>{{ titoloApp }}</q-toolbar-title>
                    <q-btn flat round dense icon="add" v-if="vistaCorrente === 'home'" @click="dialogNuovoCorso = true"></q-btn>
                </q-toolbar>
            </q-header>

            <q-page-container>
                <q-page class="q-pa-md">
                    
                    <div v-show="vistaCorrente === 'home'">
                        <div v-if="loading" class="text-center q-mt-xl"><q-spinner size="3em" color="primary"></q-spinner></div>
                        <div v-else>
                            <q-banner v-if="listaCorsi.length === 0" class="bg-blue-1 q-mb-md rounded-borders">
                                Nessun corso. Premi + in alto per crearne uno.
                            </q-banner>
                            <q-card v-for="corso in listaCorsi" :key="corso.id" class="my-card" v-ripple @click="apriCorso(corso)">
                                <q-card-section class="row items-center justify-between">
                                    <div>
                                        <div class="text-h6">{{ corso.nome }}</div>
                                        <div class="text-caption text-grey">{{ corso.data }}</div>
                                    </div>
                                    <q-btn flat round color="red" icon="delete" @click.stop="eliminaCorso(corso.id)"></q-btn>
                                </q-card-section>
                            </q-card>
                        </div>
                    </div>

                    <div v-show="vistaCorrente === 'dettaglio'">
                        
                        <div class="row q-col-gutter-sm q-mb-md">
                            <div class="col-4">
                                <q-card class="bg-primary text-white text-center">
                                    <q-card-section class="q-pa-sm">
                                        <div class="text-h5">{{ statistiche.media }}</div>
                                        <div class="text-caption" style="font-size: 10px">MEDIA</div>
                                    </q-card-section>
                                </q-card>
                            </div>
                            <div class="col-4">
                                <q-card class="bg-green text-white text-center">
                                    <q-card-section class="q-pa-sm">
                                        <div class="text-h5">{{ statistiche.promossi }}</div>
                                        <div class="text-caption" style="font-size: 10px">PROMOSSI</div>
                                    </q-card-section>
                                </q-card>
                            </div>
                            <div class="col-4">
                                <q-card class="bg-red text-white text-center">
                                    <q-card-section class="q-pa-sm">
                                        <div class="text-h5">{{ statistiche.bocciati }}</div>
                                        <div class="text-caption" style="font-size: 10px">BOCCIATI</div>
                                    </q-card-section>
                                </q-card>
                            </div>
                        </div>

                        <div class="row q-mb-md items-center">
                            <div class="col">
                                <q-input outlined dense v-model="testoRicerca" placeholder="Cerca..." bg-color="white">
                                    <template v-slot:append><q-icon name="search" /></template>
                                </q-input>
                            </div>
                            <div class="col-auto q-ml-sm">
                                <q-btn round color="green" icon="file_download" @click="scaricaExcel"></q-btn>
                            </div>
                        </div>

                        <div class="row q-col-gutter-sm q-mb-md">
                            <div class="col-8">
                                <q-btn color="secondary" class="full-width shadow-2" icon="camera_alt" label="SCANSIONA" size="lg" @click="attivaCamera"></q-btn>
                            </div>
                            <div class="col-4">
                                <q-btn color="grey-8" class="full-width shadow-2" icon="edit_note" label="MANUALE" size="lg" @click="apriInserimentoManuale"></q-btn>
                            </div>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" @change="processaImmagine">
                        </div>

                        <q-table
                            :rows="studentiFiltrati"
                            :columns="colonneStudenti"
                            row-key="id"
                            no-data-label="Nessun dato."
                            :pagination="{ rowsPerPage: 0 }"
                            dense
                        >
                            <template v-slot:body-cell-voto="props">
                                <q-td :props="props">
                                    <q-badge :color="props.row.voto >= 18 ? 'green' : 'red'">
                                        {{ props.row.voto }}
                                    </q-badge>
                                </q-td>
                            </template>
                            
                            <template v-slot:body-cell-actions="props">
                                <q-td :props="props" auto-width>
                                    <q-btn flat round dense color="blue" icon="edit" @click="modificaStudente(props.row)"></q-btn>
                                    <q-btn flat round dense color="red" icon="delete" @click="eliminaStudente(props.row.id)"></q-btn>
                                </q-td>
                            </template>
                        </q-table>
                    </div>
                </q-page>
            </q-page-container>

            <q-dialog v-model="dialogStudente" persistent>
                <q-card style="width: 100vw; max-width: 400px">
                    <q-card-section class="bg-primary text-white">
                        <div class="text-h6">{{ studenteForm.id ? 'Modifica Studente' : 'Nuovo Studente' }}</div>
                    </q-card-section>

                    <q-card-section>
                        <img v-if="anteprimaImg" :src="anteprimaImg" style="width:100%; height: 150px; object-fit: contain; background: #000; margin-bottom: 10px;">
                        
                        <div class="q-gutter-sm">
                            <q-input outlined v-model="studenteForm.matricola" label="Matricola *" type="number"></q-input>
                            <div class="row q-col-gutter-sm">
                                <div class="col-6">
                                    <q-input outlined v-model="studenteForm.nome" label="Nome"></q-input>
                                </div>
                                <div class="col-6">
                                    <q-input outlined v-model="studenteForm.cognome" label="Cognome"></q-input>
                                </div>
                            </div>
                            <q-input outlined v-model="studenteForm.voto" label="Voto *" type="number" bg-color="yellow-1" class="text-bold"></q-input>
                        </div>
                    </q-card-section>

                    <q-card-actions align="right">
                        <q-btn flat label="Annulla" color="red" v-close-popup></q-btn>
                        <q-btn unelevated :label="studenteForm.id ? 'AGGIORNA' : 'SALVA'" color="green" @click="salvaStudenteDB"></q-btn>
                    </q-card-actions>
                </q-card>
            </q-dialog>

            <q-dialog v-model="dialogNuovoCorso">
                <q-card style="min-width: 300px">
                    <q-card-section><div class="text-h6">Crea Corso</div></q-card-section>
                    <q-card-section>
                        <q-input filled v-model="nuovoCorso.nome" label="Nome Materia" autofocus></q-input>
                    </q-card-section>
                    <q-card-actions align="right">
                        <q-btn flat label="Annulla" v-close-popup></q-btn>
                        <q-btn flat label="Salva" color="primary" @click="salvaCorso" v-close-popup></q-btn>
                    </q-card-actions>
                </q-card>
            </q-dialog>

        </q-layout>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.14.1/dist/quasar.umd.prod.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="app.js"></script>
</body>
</html>